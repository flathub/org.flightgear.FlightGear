id: org.flightgear.FlightGear
runtime: org.kde.Platform
runtime-version: 6.10
sdk: org.kde.Sdk
command: flightgear.sh
rename-icon: flightgear
finish-args:
  # IPC is required for X11, otherwise the performance is not great
  - --share=ipc
  - --socket=x11
  # Joysticks, yokes, etc. are not handled by libinput/wayland/x11, so the application
  # needs direct access to those peripherals. When a more sandbox-proof solution
  # is in place, replace it with "--device=dri" for GPU acceleration
  - --device=all
  - --socket=pulseaudio
  - --share=network
  - --persist=.fgfs
  # $FG_HOME is the place were FlightGear data is written to, contrary to $FG_ROOT, which is generally read-only.
  # It is safe to store the built-in flightgear-data under /app, which is writable but non-persistent.
  # The $FG_ROOT can still be changed by passing the "--fg-root" option when calling "flatpak run".
  - --env=FG_ROOT=/app/share/flightgear
cleanup:
  - /include
  - /lib/pkgconfig
  - /lib64/pkgconfig
  - /lib/cmake
  - /share/doc
  - /share/man
  - '*.h'
  - '*.a'
  - '*.la'
  - '*.cmake'
modules:
  - name: boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app
      - ./b2 headers -j $FLATPAK_BUILDER_N_JOBS
      - ./b2 --build-type=minimal -j $FLATPAK_BUILDER_N_JOBS install
    sources:
      - type: archive
        url: https://archives.boost.io/release/1.90.0/source/boost_1_90_0.tar.bz2
        sha256: 49551aff3b22cbc5c5a9ed3dbc92f0e23ea50a0f7325b0d198b705e8ee3fc305
        x-checker-data:
          type: anitya
          project-id: 6845
          stable-only: true
          url-template: https://archives.boost.io/release/$version/source/boost_${major}_${minor}_$patch.tar.bz2

  - shared-modules/glu/glu-9.json
  - shared-modules/glew/glew.json

  - name: openscenegraph
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://gitlab.com/flightgear/openscenegraph/-/archive/release/2024-build/openscenegraph-release-2024-build.tar.bz2
        sha256: 0a3d0d45168d5d5cd389682d4b7260b72e1f9582a03d03dda1261b6b0dff34f5

  - name: xmu
    sources:
      - type: archive
        url: https://gitlab.freedesktop.org/xorg/lib/libxmu/-/archive/libXmu-1.3.1/libxmu-libXmu-1.3.1.tar.gz
        sha256: a38bff41f609e2ea887c05fb4a31e926a03ba1d69ddda9423682e198839f2355
        x-checker-data:
          type: anitya
          project-id: 1785
          url-template: https://gitlab.freedesktop.org/xorg/lib/libxmu/-/archive/libXmu-$version/libxmu-libXmu-$version.tar.gz

  - name: plib
    sources:
      - type: archive
        url: http://plib.sourceforge.net/dist/plib-1.8.5.tar.gz
        sha256: 485b22bf6fdc0da067e34ead5e26f002b76326f6371e2ae006415dea6a380a32
        x-checker-data:
          type: anitya
          project-id: 9894
          url-template: http://plib.sourceforge.net/dist/plib-$version.tar.gz

  - name: libevent
    buildsystem: autotools
    sources:
      - type: archive
        url: https://github.com/libevent/libevent/archive/refs/tags/release-2.1.12-stable.tar.gz
        sha256: 7180a979aaa7000e1264da484f712d403fcf7679b1e9212c4e3d09f5c93efc24
        x-checker-data:
          type: anitya
          project-id: 1606
          url-template: https://github.com/libevent/libevent/archive/refs/tags/release-$version-stable.tar.gz

  - name: c-ares
    builddir: true
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCARES_BUILD_TOOLS=OFF
    sources:
      - type: archive
        url: https://github.com/c-ares/c-ares/archive/refs/tags/v1.34.6.tar.gz
        sha256: 4358939ff800b13b92f37d5fdda003718101faedfbdee792d6b79ddc1a53d890
        x-checker-data:
          type: anitya
          project-id: 5840
          url-template: https://github.com/c-ares/c-ares/archive/refs/tags/v$version.tar.gz

  - name: simgear
    builddir: true
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DOpenGL_GL_PREFERENCE=GLVND
      - -DENABLE_TESTS=OFF
    sources:
      - type: archive
        url: https://gitlab.com/flightgear/simgear/-/archive/2024.1.4/simgear-2024.1.4.tar.bz2
        sha256: f8cb19d95f574a4f9ceb57f473963d3b185a4cacd6d948b528dcaebfb2807e05

  - name: flightgear-data
    buildsystem: simple
    sources:
      - type: archive
        url: https://gitlab.com/flightgear/fgdata/-/archive/2024.1.4/fgdata-2024.1.4.tar.bz2
        sha256: 7a856ae4d2b5dd25005d47801f22857a7c4b78a5f57bacedfd3a8c44ec02993d
        dest: fgdata
    build-commands:
      - mkdir --parents /app/share/flightgear
      - mv fgdata/* /app/share/flightgear/

  - name: flightgear
    buildsystem: cmake-ninja
    config-opts:
      - -DENABLE_QT=ON
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DFG_BUILD_TYPE=Release
      - -DOpenGL_GL_PREFERENCE=GLVND
      # Set the path to the base data, as it can not find the translations otherwise
      - -DFG_DATA_DIR=/app/share/flightgear
      # Let FlightGear build flite, because we know it will work
      - -DSYSTEM_FLITE=0
    builddir: true
    sources:
      - type: archive
        url: https://gitlab.com/flightgear/flightgear/-/archive/2024.1.4/flightgear-2024.1.4.tar.bz2
        sha256: c551e7560bd172072ed48e31176124295af20f2603becff807f5738802301163
      - type: file
        path: org.flightgear.FlightGear.metainfo.xml
      - type: script
        commands:
          - fgfs --launcher "$@"
        dest-filename: flightgear.sh
    post-install:
      - install -Dm644 ../org.flightgear.FlightGear.metainfo.xml /app/share/metainfo/org.flightgear.FlightGear.metainfo.xml
      - install -Dm755 ../flightgear.sh /app/bin/flightgear.sh
      - desktop-file-edit --set-key=Exec --set-value=flightgear.sh /app/share/applications/org.flightgear.FlightGear.desktop
      - desktop-file-edit --set-key=StartupWMClass --set-value=FlightGear /app/share/applications/org.flightgear.FlightGear.desktop
      - desktop-file-edit --set-key=Name --set-value="FlightGear" /app/share/applications/org.flightgear.FlightGear.desktop
